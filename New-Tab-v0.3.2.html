<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New-Tab</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      :root {
        /* colour */
        --primary-color: #2196f3;
        --text-color: #333;
        --text-light: #5e5e5e;
        --bg-light: #f5f7fa;
        --bg-dark: #c3cfe2;
        --shadow-sm: 0 4px 10px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
        --transition-fast: 0.18s cubic-bezier(0.4, 1.4, 0.6, 1);
        --transition-normal: 0.2s;
        --border-radius-sm: 4px;
        --border-radius-md: 8px;
        --border-radius-lg: 16px;
        
        /* size */
        --app-icon-size: 60px;
        --app-icon-img-size: 35px;
        --search-bar-width: 750px;
        --modal-width: 420px;
        --modal-min-height: 500px;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .search-bar {
        align-items: center; /* Vertical center */
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        padding: 10px 20px;
        border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        width: var(--search-bar-width);
        margin-left: auto;
        margin-right: auto;
        transition: transform 0.18s cubic-bezier(0.4, 1.4, 0.6, 1);
      }
      .search-bar:focus-within {
        transform: scale(1.04);
        box-shadow: 0 6px 24px rgba(33, 150, 243, 0.13);
      }
      .search-bar input {
        width: 100%;
        padding: 6px;
        border: none;
        background: transparent;
        font-size: 20px;
        outline: none;
        flex: 1; /* Automatically expand to fill remaining space */
      }
      .search-engine {
        -webkit-appearance: none;
        appearance: none;
        background: url('data:image/svg+xml;utf8,<svg fill="%23999" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>')
          no-repeat right 8px center;
        padding: 6px 30px 6px 10px;
        border-radius: 4px;
        margin-right: 10px;
        min-width: 80px; /* Minimum width to prevent content overflow */
        border-color: #b7b7b7;
      }

      .app-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .app-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #333;
        transition: transform 0.2s;
      }

      .app-icon:hover {
        transform: scale(1.05);
      }

      .icon {
        width: var(--app-icon-size);
        height: var(--app-icon-size);
        background: white;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 8px;
      }

      .icon img {
        width: var(--app-icon-img-size);
        height: var(--app-icon-img-size);
      }

      .app-name {
        font-size: 12px;
        text-align: center;
        color: #fff;
        text-shadow: 0 0 2px #000, 0 0 2px #000, 0 0 2px #000, 0 0 2px #000;
      }

      .clock {
        text-align: center;
        font-size: 5em;
        color: #5e5e5e;
        margin-bottom: 20px;
        font-weight: 300;
      }

      .date {
        text-align: center;
        color: #ffffff;
        margin-bottom: 30px;
        font-size: 1.5em;
      }

      /* Settings Modal Styles */
      #settings-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0); /* transparent overlay for window style */
        z-index: 1000;
        align-items: flex-start;
        justify-content: flex-start;
      }
      #settings-modal > div {
        background: #fff;
        border-radius: 16px;
        padding: 0;
        min-width: 280px;
        max-width: 420px;
        width: 420px;
        min-height: 500px;
        max-height: none;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        right: auto;
        display: flex;
        flex-direction: column;
      }
      .settings-body {
        display: flex;
        min-height: 400px;
      }
      .settings-menu {
        width: 160px;
        background: #f5f7fa;
        border-top-left-radius: 16px;
        border-bottom-left-radius: 16px;
        padding: 24px 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .settings-menu-item {
        background: none;
        border: none;
        color: #333;
        font-size: 1em;
        cursor: pointer;
        padding: 10px 20px;
        text-align: left;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .settings-menu-item:hover {
        background: #e0e0e0;
      }
      .settings-menu-item.selected {
        background: #2196f3;
        color: white;
      }
      .settings-content {
        flex: 1;
        padding: 20px 20px 16px 20px;
        font-size: 1em;
        overflow: visible;
      }
      .settings-content label,
      .settings-content .bg-thumbnails,
      .settings-content > div {
        margin-bottom: 10px !important;
      }
      .settings-content label {
        margin-bottom: 6px !important;
      }
      .settings-content > div[style*="margin-top"] {
        margin-top: 12px !important;
      }

      .bg-thumbnails {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
        margin-bottom: 16px;
      }
      .bg-thumb {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid transparent;
        cursor: pointer;
        transition: border 0.2s;
      }
      .bg-thumb.selected {
        border: 2px solid #2196f3;
      }

      /* Add App Modal Styles */
      #add-app-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      }

      #add-app-modal > div {
        background: #fff;
        border-radius: 16px;
        padding: 24px 20px;
        min-width: 280px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        position: relative;
        max-width: 90vw;
      }

      #add-app-modal h3 {
        margin-bottom: 12px;
        font-size: 1.2em;
      }

      #add-app-modal input {
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
      }

      #add-app-modal button {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
      }

      #add-app-modal button#add-app-confirm {
        background: #2196f3;
        color: white;
      }

      #add-app-modal button#add-app-cancel {
        background: #eee;
      }

      /* Settings section options vertical layout */
      .settings-section label {
        display: block;
        margin-bottom: 12px;
      }
      .settings-section input[type="radio"] {
        margin-right: 6px;
      }
      .settings-section select,
      .settings-section input[type="color"],
      .settings-section input[type="number"] {
        margin-top: 4px;
        margin-bottom: 4px;
      }
      .settings-section button {
        margin-top: 10px;
      }
    </style>
    <script src="motto.js"></script>
  <script src="backgrounds.js"></script>
  </head>
  <body>
    <div class="container">
      <div id="clock" class="clock">12:00</div>
      <div id="date" class="date">Monday, June 20</div>

      <div class="search-bar">
        <select
          class="search-engine"
          style="
            border: none;
            background: transparent;
            padding: 6px;
            font-size: 16px;
            margin-right: 10px;
          "
        >
          <input type="text" placeholder="Search or enter website" />
        </select>
      </div>

      <div class="app-grid" id="app-grid" style="user-select: none;">
        <a
          href="https://github.com/404-Page-Found/New-Tab/issues/new"
          class="app-icon default-app"
          target="_blank"
          rel="noopener noreferrer"
          id="feedback-app"
          draggable="true"
        >
          <div class="icon">
            <img src="https://cdn-icons-png.flaticon.com/512/545/545705.png" alt="Feedback" />
          </div>
          <span class="app-name">Feedback</span>
        </a>
        <a href="#" class="app-icon default-app" id="settings-app" draggable="true">
          <div class="icon">
            <img
              src="https://cdn-icons-png.flaticon.com/512/3524/3524636.png"
              alt="Settings"
            />
          </div>
          <span class="app-name">Settings</span>
        </a>
        <a href="#" class="app-icon" id="add-app" draggable="false">
          <div class="icon">
            <img
              src="https://cdn-icons-png.flaticon.com/512/1828/1828817.png"
              alt="Add"
              style="width: 32px; height: 32px"
            />
          </div>
          <span class="app-name">Add</span>
        </a>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settings-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0);
        z-index: 1000;
        align-items: flex-start;
        justify-content: flex-start;
      "
    >
      <div>
        <div class="settings-body" style="display: flex; min-height: 400px">
          <nav
            class="settings-menu"
            style="
              width: 160px;
              background: #f5f7fa;
              border-top-left-radius: 16px;
              border-bottom-left-radius: 16px;
              padding: 24px 0 24px 0;
              display: flex;
              flex-direction: column;
              gap: 8px;
            "
          >
            <button class="settings-menu-item selected" data-section="general">
              General
            </button>
            <button class="settings-menu-item" data-section="background">
              Background
            </button>
            <button class="settings-menu-item" data-section="apps">Apps</button>
            <button class="settings-menu-item" data-section="clock">
              Clock
            </button>
            <button class="settings-menu-item" data-section="date">Date</button>
          </nav>
          <div class="settings-content" style="flex: 1">
            <section class="settings-section" data-section="general">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  cursor: pointer;
                "
                onclick="document.getElementById('open-new-tab-setting').click(); return false;"
              >
                <input
                  type="checkbox"
                  id="open-new-tab-setting"
                  style="cursor: pointer"
                  onclick="event.stopPropagation();"
                />
                Open apps in a new tab
              </label>
            </section>
            <section
              class="settings-section"
              data-section="background"
              style="display: none"
            >
              <div class="bg-thumbnails" id="bg-thumbnails"></div>
            </section>
            <section
              class="settings-section"
              data-section="apps"
              style="display: none"
            >
              <label
                ><input type="radio" name="curvature" value="0" /> Square</label
              >
              <label
                ><input type="radio" name="curvature" value="15" />
                Rounded</label
              >
              <label
                ><input type="radio" name="curvature" value="50" />
                Circle</label
              >
            </section>
            <section
              class="settings-section"
              data-section="clock"
              style="display: none"
            >
              <label
                >Color:<br /><input type="color" id="clock-color-picker"
              /></label>
              <label
                >Font:<br />
                <select id="clock-font-picker">
                  <option
                    value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
                  >
                    Default
                  </option>
                  <option value="'Arial', sans-serif">Arial</option>
                  <option value="'Courier New', monospace">Courier New</option>
                  <option value="'Times New Roman', serif">
                    Times New Roman
                  </option>
                  <option value="'Comic Sans MS', cursive">
                    Comic Sans MS
                  </option>
                  <option value="'Georgia', serif">Georgia</option>
                </select>
              </label>
              <label
                >Size:<br />
                <input
                  type="number"
                  id="clock-size-picker"
                  min="20"
                  max="200"
                  value="80"
                  style="width: 60px"
                />
                px
              </label>
              <button id="clock-style-reset">Reset Clock Style</button>
            </section>
            <section
              class="settings-section"
              data-section="date"
              style="display: none"
            >
              <label
                >Color:<br /><input type="color" id="date-color-picker"
              /></label>
              <label
                >Font:<br />
                <select id="date-font-picker">
                  <option
                    value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
                  >
                    Default
                  </option>
                  <option value="'Arial', sans-serif">Arial</option>
                  <option value="'Courier New', monospace">Courier New</option>
                  <option value="'Times New Roman', serif">
                    Times New Roman
                  </option>
                  <option value="'Comic Sans MS', cursive">
                    Comic Sans MS
                  </option>
                  <option value="'Georgia', serif">Georgia</option>
                </select>
              </label>
              <label
                >Size:<br />
                <input
                  type="number"
                  id="date-size-picker"
                  min="10"
                  max="80"
                  value="24"
                  style="width: 60px"
                />
                px
              </label>
              <button id="date-style-reset">Reset Date Style</button>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- Add App Modal -->
    <div
      id="add-app-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #fff;
          border-radius: 16px;
          padding: 24px 20px;
          min-width: 200px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
          position: relative;
          max-width: 80vw;
        "
      >
        <h3 style="margin-bottom: 12px">Add New App</h3>
        <input
          id="add-app-url"
          type="text"
          placeholder="Enter website URL"
          style="width: 100%; padding: 8px; margin-bottom: 12px"
        />
        <div id="default-apps-list" style="margin-bottom: 12px"></div>
        <div style="text-align: right">
          <button id="add-app-cancel" style="margin-right: 8px">Cancel</button>
          <button id="add-app-confirm">Add</button>
        </div>
      </div>
    </div>

  <!-- TinyMind removed -->
    <script>
      // --- Drag and Drop for App Grid ---
      // Helper: get all app icons (default and custom, but not Add)
      function getDraggableAppIcons() {
        return Array.from(document.querySelectorAll('.app-grid .app-icon'))
          .filter(icon => icon.id !== 'add-app');
      }

      // Helper: get order from localStorage (for custom apps)
      function getAppOrder() {
        return JSON.parse(localStorage.getItem('appOrder') || 'null');
      }
      function saveAppOrder(order) {
        localStorage.setItem('appOrder', JSON.stringify(order));
      }

      // Helper: get all app data (default and custom, with persistent IDs)
      function getAllAppData() {
        // Default apps (Feedback, Settings)
        const defaultApps = [
          {
            id: 'feedback-app',
            name: 'Feedback',
            url: 'https://github.com/404-Page-Found/New-Tab/issues/new',
            icon: 'https://cdn-icons-png.flaticon.com/512/545/545705.png',
            className: 'default-app',
          },
          {
            id: 'settings-app',
            name: 'Settings',
            url: '#',
            icon: 'https://cdn-icons-png.flaticon.com/512/3524/3524636.png',
            className: 'default-app',
          },
        ];
        // Custom apps (must have persistent id)
        const customApps = loadCustomApps().map((app) => ({
          ...app,
          className: 'custom-app',
        }));
        return [...defaultApps, ...customApps];
      }

      // Render all apps in order
      function renderAllApps() {
        const appGrid = document.getElementById('app-grid');
        // Remove all except Add
        Array.from(appGrid.children).forEach(child => {
          if (child.id !== 'add-app') appGrid.removeChild(child);
        });
        // Get order
        let order = getAppOrder();
        const allApps = getAllAppData();
        if (!order || order.length !== allApps.length) {
          // Fallback: default order
          order = allApps.map(app => app.id);
          saveAppOrder(order);
        }
        // Render in order
        order.forEach(appId => {
          const app = allApps.find(a => a.id === appId);
          if (!app) return;
          let a = document.createElement('a');
          a.href = app.url;
          a.className = 'app-icon ' + app.className;
          a.id = app.id;
          a.draggable = true;
          if (app.className === 'custom-app') {
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
          }
          a.innerHTML = `<div class="icon"><img src="${app.icon}" alt="${app.name}" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/globe.svg';"></div><span class="app-name">${app.name}</span>`;
          appGrid.insertBefore(a, document.getElementById('add-app'));
        });
      }

      // Drag and drop logic
      let dragSrcId = null;
      function handleDragStart(e) {
        dragSrcId = this.id;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      }
      function handleDragEnd(e) {
        this.classList.remove('dragging');
      }
      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        // Visual cue
        this.classList.add('drag-over');
      }
      function handleDragLeave(e) {
        this.classList.remove('drag-over');
      }
      function handleDrop(e) {
        e.stopPropagation();
        this.classList.remove('drag-over');
        if (dragSrcId === this.id) return;
        // Reorder
        let order = getAppOrder();
        const fromIdx = order.indexOf(dragSrcId);
        const toIdx = order.indexOf(this.id);
        if (fromIdx === -1 || toIdx === -1) return;
        order.splice(toIdx, 0, order.splice(fromIdx, 1)[0]);
        saveAppOrder(order);
        renderAllApps();
        attachDnDEvents();
      }
      function attachDnDEvents() {
        getDraggableAppIcons().forEach(icon => {
          icon.addEventListener('dragstart', handleDragStart);
          icon.addEventListener('dragend', handleDragEnd);
          icon.addEventListener('dragover', handleDragOver);
          icon.addEventListener('dragleave', handleDragLeave);
          icon.addEventListener('drop', handleDrop);
        });
      }

      // Initial render and attach events
      renderAllApps();
      attachDnDEvents();

      // Re-render and re-attach events after custom app changes
      const origRenderCustomApps = renderCustomApps;
      renderCustomApps = function() {
        // Update app order to include new custom apps
        const allApps = getAllAppData();
        let order = getAppOrder();
        if (!order || order.length !== allApps.length) {
          order = allApps.map(app => app.id);
          saveAppOrder(order);
        }
        renderAllApps();
        attachDnDEvents();
        if (origRenderCustomApps) origRenderCustomApps();
      };
      function updateTime() {
        const now = new Date();
        const timeElement = document.getElementById("clock");
        const dateElement = document.getElementById("date");

        // Update time
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        timeElement.textContent = `${hours}:${minutes}`;

        // Update date
        const options = { weekday: "long", month: "long", day: "numeric" };
        dateElement.textContent = now.toLocaleDateString("en-US", options);
      }

      // Update time immediately and then every minute
      updateTime();
      setInterval(updateTime, 60000);

      // Search Engine Configuration
      const searchEngines = {
        bing: {
          name: "Bing",
          url: " https://www.bing.com/search?q=",
        },
        duckduckgo: {
          name: "DuckDuckGo",
          url: " https://duckduckgo.com/?q=",
        },
        google: {
          name: "Google",
          url: "https://www.google.com/search?q=",
        },
      };

      // Load saved search engine
      function getSavedEngine() {
        return localStorage.getItem("defaultEngine") || "google";
      }

      // Save search engine
      function saveEngine(engine) {
        localStorage.setItem("defaultEngine", engine);
      }

      // Initialize search engine dropdown
      function initSearchEngine() {
        const select = document.querySelector(".search-engine");
        const savedEngine = getSavedEngine();

        // Set current selection
        select.innerHTML = "";

        // Add options
        Object.keys(searchEngines).forEach((key) => {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = searchEngines[key].name;
          select.appendChild(option);
        });

        // Set selection last (ensure option exists)
        select.value = savedEngine;

        // Listen for selection changes
        select.addEventListener("change", (e) => {
          saveEngine(e.target.value);
        });
      }

      // 修改搜索事件监听器
      document
        .querySelector(".search-bar input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            const query = this.value.trim();
            if (!query) return;

            const selectedEngine = searchEngines[getSavedEngine()];

            if (query.includes(".")) {
              // Handle URL input
              window.location.href = query.startsWith("http")
                ? query
                : `https://${query}`;
            } else {
              // Use selected search engine
              window.location.href = `${selectedEngine.url}${encodeURIComponent(
                query
              )}`;
            }
          }
        });

      // Initialize on page load
      initSearchEngine();

      // Settings modal logic
      const settingsApp = document.getElementById("settings-app");
      const settingsModal = document.getElementById("settings-modal");
      // const closeSettings = document.getElementById("close-settings"); // This element no longer exists
      const openNewTabSetting = document.getElementById("open-new-tab-setting");
      const appLinks = document.querySelectorAll(".app-grid .app-icon");

      // Load setting from localStorage
      function loadOpenNewTabSetting() {
        return localStorage.getItem("openAppsInNewTab") !== "false";
      }
      function applyOpenNewTabSetting() {
        const openInNewTab = loadOpenNewTabSetting();
        appLinks.forEach((link) => {
          if (link.id === "settings-app") return;
          if (openInNewTab) {
            link.setAttribute("target", "_blank");
            link.setAttribute("rel", "noopener noreferrer");
          } else {
            link.removeAttribute("target");
            link.removeAttribute("rel");
          }
        });
        openNewTabSetting.checked = openInNewTab;
      }
      openNewTabSetting.addEventListener("change", function () {
        localStorage.setItem("openAppsInNewTab", this.checked);
        applyOpenNewTabSetting();
      });
      settingsApp.addEventListener("click", function (e) {
        e.preventDefault();
        settingsModal.style.display = "flex";
      });
      // Close modal on outside click
      settingsModal.addEventListener("click", function (e) {
        if (e.target === settingsModal) settingsModal.style.display = "none";
      });

      // Add App logic
      const addAppBtn = document.getElementById("add-app");
      const addAppModal = document.getElementById("add-app-modal");
      const addAppUrlInput = document.getElementById("add-app-url");
      const addAppCancel = document.getElementById("add-app-cancel");
      const addAppConfirm = document.getElementById("add-app-confirm");
      const appGrid = document.querySelector(".app-grid");

      function getFavicon(url) {
        try {
          const u = new URL(url.startsWith("http") ? url : "https://" + url);
          return u.origin + "/favicon.ico";
        } catch {
          return "";
        }
      }

      function loadCustomApps() {
        return JSON.parse(localStorage.getItem("customApps") || "[]");
      }
      function saveCustomApps(apps) {
        localStorage.setItem("customApps", JSON.stringify(apps));
      }
      function renderCustomApps() {
        // No-op: handled by renderAllApps
      }

      addAppBtn.addEventListener("click", function (e) {
        e.preventDefault();
        addAppModal.style.display = "flex";
        addAppUrlInput.value = "";
        addAppUrlInput.focus();
      });
      addAppCancel.addEventListener("click", function () {
        addAppModal.style.display = "none";
      });
      addAppModal.addEventListener("click", function (e) {
        if (e.target === addAppModal) addAppModal.style.display = "none";
      });
      addAppConfirm.addEventListener("click", function () {
        const url = addAppUrlInput.value.trim();
        if (!url) return;
        let name = url.replace(/^https?:\/\//, "").split("/")[0];
        const icon = getFavicon(url);
        const apps = loadCustomApps();
        // Assign a persistent unique id
        const id = 'custom-app-' + Date.now() + '-' + Math.floor(Math.random()*100000);
        apps.push({
          id,
          url: url.startsWith("http") ? url : "https://" + url,
          name,
          icon,
        });
        saveCustomApps(apps);
        // Update appOrder to include new app
        let order = getAppOrder() || [];
        order.push(id);
        saveAppOrder(order);
        renderCustomApps();
        addAppModal.style.display = "none";
      });

      // Curvature logic (radio buttons)
      const curvatureRadios = document.querySelectorAll(
        'input[name="curvature"]'
      );
      function loadCurvature() {
        return localStorage.getItem("appsButtonCurvature") || "15";
      }
      function applyCurvature() {
        const radius = loadCurvature();
        document.querySelectorAll('.icon').forEach((icon) => {
          icon.style.borderRadius = radius + "px";
        });
        curvatureRadios.forEach((radio) => {
          radio.checked = radio.value === radius;
        });
      }
      curvatureRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
          if (this.checked) {
            localStorage.setItem("appsButtonCurvature", this.value);
            applyCurvature();
          }
        });
      });

      // Background selection logic
  // Thumbnails are generated by backgrounds.js; ensure initialization
  if (window._initBackgrounds) window._initBackgrounds();
  const bgThumbnails = document.getElementById('bg-thumbnails');
      function loadBg() {
        return localStorage.getItem("homepageBg") || "default";
      }
      function applyBg() {
        const bg = loadBg();
        document.body.setAttribute("data-bg", bg);
        const thumbs = document.querySelectorAll('.bg-thumb');
        thumbs.forEach((thumb) => {
          thumb.classList.toggle(
            'selected',
            thumb.getAttribute('data-bg') === bg
          );
        });
        if (bg !== 'default') {
          const imgUrl =
            (window._findBackgroundUrlById && window._findBackgroundUrlById(bg)) || '';
          if (imgUrl) document.body.style.background = `url('${imgUrl}') center center/cover no-repeat fixed`;
          else document.body.style.background = '';
        } else {
          document.body.style.background = '';
        }
      }

      // Delegate click events for dynamically-created thumbnails
      document.addEventListener('click', function (e) {
        const t = e.target.closest && e.target.closest('.bg-thumb');
        if (t && t.getAttribute('data-bg')) {
          localStorage.setItem('homepageBg', t.getAttribute('data-bg'));
          applyBg();
        }
      });

      // Clock style settings logic
      const clock = document.getElementById("clock");
      const clockColorPicker = document.getElementById("clock-color-picker");
      const clockFontPicker = document.getElementById("clock-font-picker");
      const clockSizePicker = document.getElementById("clock-size-picker");
      const clockStyleReset = document.getElementById("clock-style-reset");
      // Date style settings logic
      const date = document.getElementById("date");
      const dateColorPicker = document.getElementById("date-color-picker");
      const dateFontPicker = document.getElementById("date-font-picker");
      const dateSizePicker = document.getElementById("date-size-picker");
      const dateStyleReset = document.getElementById("date-style-reset");

      function loadClockStyle() {
        return {
          color: localStorage.getItem("clockColor") || "#5e5e5e",
          font:
            localStorage.getItem("clockFont") ||
            "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
          size: localStorage.getItem("clockSize") || "80",
        };
      }
      function applyClockStyle() {
        const style = loadClockStyle();
        clock.style.color = style.color;
        clock.style.fontFamily = style.font;
        clock.style.fontSize = style.size + "px";
        clockColorPicker.value = style.color;
        clockFontPicker.value = style.font;
        clockSizePicker.value = style.size;
      }
      clockColorPicker.addEventListener("input", function () {
        localStorage.setItem("clockColor", this.value);
        applyClockStyle();
      });
      clockFontPicker.addEventListener("change", function () {
        localStorage.setItem("clockFont", this.value);
        applyClockStyle();
      });
      clockSizePicker.addEventListener("input", function () {
        let val = this.value;
        if (val < 20) val = 20;
        if (val > 200) val = 200;
        localStorage.setItem("clockSize", val);
        applyClockStyle();
      });
      clockStyleReset.addEventListener("click", function () {
        localStorage.removeItem("clockColor");
        localStorage.removeItem("clockFont");
        localStorage.removeItem("clockSize");
        applyClockStyle();
      });
      // Date style logic
      function loadDateStyle() {
        return {
          color: localStorage.getItem("dateColor") || "#666666",
          font:
            localStorage.getItem("dateFont") ||
            "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
          size: localStorage.getItem("dateSize") || "24",
        };
      }
      function applyDateStyle() {
        const style = loadDateStyle();
        date.style.color = style.color;
        date.style.fontFamily = style.font;
        date.style.fontSize = style.size + "px";
        dateColorPicker.value = style.color;
        dateFontPicker.value = style.font;
        dateSizePicker.value = style.size;
      }
      dateColorPicker.addEventListener("input", function () {
        localStorage.setItem("dateColor", this.value);
        applyDateStyle();
      });
      dateFontPicker.addEventListener("change", function () {
        localStorage.setItem("dateFont", this.value);
        applyDateStyle();
      });
      dateSizePicker.addEventListener("input", function () {
        let val = this.value;
        if (val < 10) val = 10;
        if (val > 80) val = 80;
        localStorage.setItem("dateSize", val);
        applyDateStyle();
      });
      dateStyleReset.addEventListener("click", function () {
        localStorage.removeItem("dateColor");
        localStorage.removeItem("dateFont");
        localStorage.removeItem("dateSize");
        applyDateStyle();
      });
  // Initial setup
  applyOpenNewTabSetting();
  applyCurvature();
  applyBg();
  applyClockStyle();
  applyDateStyle();

      // Settings menu logic
      const settingsMenuItems = document.querySelectorAll(
        ".settings-menu-item"
      );
      const settingsSections = document.querySelectorAll(".settings-section");
      settingsMenuItems.forEach((item) => {
        item.addEventListener("click", function () {
          const section = this.getAttribute("data-section");
          settingsMenuItems.forEach((i) => i.classList.remove("selected"));
          this.classList.add("selected");
          settingsSections.forEach((s) => {
            s.style.display =
              s.getAttribute("data-section") === section ? "block" : "none";
          });
        });
      });

      // Settings menu navigation logic
      document.querySelectorAll(".settings-menu-item").forEach((btn) => {
        btn.addEventListener("click", function () {
          document
            .querySelectorAll(".settings-menu-item")
            .forEach((b) => b.classList.remove("selected"));
          this.classList.add("selected");
          const section = this.getAttribute("data-section");
          document.querySelectorAll(".settings-section").forEach((sec) => {
            sec.style.display =
              sec.getAttribute("data-section") === section ? "" : "none";
          });
        });
      });

      // --- Add App Modal: Default Apps List ---
      // Re-attach drag and drop after adding default app
      addAppBtn.addEventListener('click', function() {
        setTimeout(attachDnDEvents, 100);
      });
      const defaultApps = [
        {
          name: "Google",
          url: "https://www.google.com",
          icon: "https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png",
        },
        {
          name: "YouTube",
          url: "https://www.youtube.com",
          icon: "https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg",
        },
        {
          name: "GitHub",
          url: "https://www.github.com",
          icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
        },
        {
          name: "Gmail",
          url: "https://www.gmail.com",
          icon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico",
        },
        {
          name: "Twitter",
          url: "https://www.twitter.com",
          icon: "https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/x.svg",
        },
        {
          name: "Facebook",
          url: "https://www.facebook.com",
          icon: "https://facebook.com/favicon.ico",
        },
        {
          name: "Feedback",
          url: "https://github.com/404-Page-Found/New-Tab/issues/new",
          icon: "https://cdn-icons-png.flaticon.com/512/545/545705.png",
        },
      ];
      const defaultAppsList = document.getElementById("default-apps-list");
      function renderDefaultAppsList() {
        defaultAppsList.innerHTML = "";
        defaultApps.forEach((app) => {
          const btn = document.createElement("button");
          btn.style.display = "inline-flex";
          btn.style.alignItems = "center";
          btn.style.gap = "8px";
          btn.style.margin = "2px 4px 2px 0";
          btn.style.padding = "6px 12px";
          btn.style.border = "1px solid #ddd";
          btn.style.borderRadius = "8px";
          btn.style.background = "#f5f7fa";
          btn.style.cursor = "pointer";
          btn.innerHTML = `${
            app.icon
              ? `<img src="${app.icon}" alt="${app.name}" style="width:20px;height:20px;object-fit:contain;background:#f5f7fa;display:block;">`
              : `<span style='display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:6px;background:#fff;font-size:16px;font-weight:bold;'>T</span>`
          } <span>${app.name}</span>`;
          btn.addEventListener("click", function () {
            // Check if already exists
            const exists = Array.from(
              document.querySelectorAll(".app-icon .app-name")
            ).some((e) => e.textContent === app.name);
            if (exists) return;
            // Add to custom apps with persistent id
            const apps = loadCustomApps();
            const id = 'custom-app-' + Date.now() + '-' + Math.floor(Math.random()*100000);
            apps.push({ id, url: app.url, name: app.name, icon: app.icon });
            saveCustomApps(apps);
            let order = getAppOrder() || [];
            order.push(id);
            saveAppOrder(order);
            renderCustomApps();
            addAppModal.style.display = "none";
          });
          defaultAppsList.appendChild(btn);
        });
      }

  // TinyMind removed
      // Prevent default behavior only when the app icon is not clicked
      document.addEventListener("contextmenu", function (e) {
        const appIcon = e.target.closest(".app-icon.custom-app, .app-icon.default-app");
        if (!appIcon) {
          e.preventDefault();
        }
      });
      // Display random motto
      function displayRandomMotto() {
        try {
          const randomIndex = Math.floor(Math.random() * motto.length);
          const mottoContainer = document.getElementById("motto-container");
          if (mottoContainer) {
            mottoContainer.textContent = motto[randomIndex];

            // Add fade-in effect
            mottoContainer.style.opacity = "0";
            setTimeout(() => {
              mottoContainer.style.transition = "opacity 0.5s";
              mottoContainer.style.opacity = "1";
            }, 50);
          }
        } catch (e) {
          console.error("Error displaying motto:", e);
        }
      }

      // Change the motto every 30 minutes.
      function setupMottoRotation() {
        displayRandomMotto(); // Initial loading display
        setInterval(displayRandomMotto, 30 * 60 * 1000); // 30 minutes
      }

      // Set the motto after the page has finished loading
      document.addEventListener("DOMContentLoaded", setupMottoRotation);
      // Create context menu element
      const contextMenu = document.createElement("div");
      contextMenu.id = "app-context-menu";
      contextMenu.style.cssText = `
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        z-index: 3000;
        min-width: 160px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 14px;
        color: #333;
      `;

      // Menu items
      const renameItem = document.createElement("div");
      renameItem.id = "rename-app";
      renameItem.textContent = "Rename";
      renameItem.style.cssText =
        "padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;";

      const changeThumbnailItem = document.createElement("div");
      changeThumbnailItem.id = "change-thumbnail";
      changeThumbnailItem.textContent = "Change Thumbnail";
      changeThumbnailItem.style.cssText =
        "padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;";

      const deleteItem = document.createElement("div");
      deleteItem.id = "delete-app";
      deleteItem.textContent = "Delete";
      deleteItem.style.cssText =
        "padding: 8px 12px; cursor: pointer; color: #f44336; transition: background 0.2s;";

      // Add hover effects
      [renameItem, changeThumbnailItem, deleteItem].forEach((item) => {
        item.addEventListener(
          "mouseenter",
          () => (item.style.background = "#f5f7fa")
        );
        item.addEventListener(
          "mouseleave",
          () => (item.style.background = "white")
        );
      });

      contextMenu.appendChild(renameItem);
      contextMenu.appendChild(changeThumbnailItem);
      contextMenu.appendChild(deleteItem);
      document.body.appendChild(contextMenu);

      // Track which app is being interacted with
      let currentAppIndex = -1;

      // Add right-click event listener to custom apps
      document.addEventListener("contextmenu", function (e) {
        const appIcon = e.target.closest(".app-icon.custom-app");
        if (appIcon) {
          e.preventDefault();

          // Find the index of this app
          const appGrid = document.querySelector(".app-grid");
          const apps = Array.from(
            appGrid.querySelectorAll(".app-icon.custom-app")
          );
          currentAppIndex = apps.indexOf(appIcon);

          // Position and show context menu
          // Adjust position if near screen edge
          let left = e.pageX;
          let top = e.pageY;

          if (left + 160 > window.innerWidth) {
            left = window.innerWidth - 160 - 10;
          }

          if (top + 100 > window.innerHeight) {
            top = window.innerHeight - 100 - 10;
          }

          contextMenu.style.left = left + "px";
          contextMenu.style.top = top + "px";
          contextMenu.style.display = "block";
        }
      });

      // Hide context menu when clicking elsewhere
      document.addEventListener("click", function (e) {
        if (!contextMenu.contains(e.target) && e.button !== 2) {
          contextMenu.style.display = "none";
        }
      });

      // Rename functionality
      document
        .getElementById("rename-app")
        .addEventListener("click", function () {
          if (currentAppIndex === -1) return;
          // Find by persistent id
          const order = getAppOrder();
          const id = order.filter(id => id.startsWith('custom-app-'))[currentAppIndex];
          const apps = loadCustomApps();
          const idx = apps.findIndex(app => app.id === id);
          if (idx === -1) return;
          const currentApp = apps[idx];
          const newName = prompt("Enter new name:", currentApp.name);
          if (newName && newName.trim() !== "") {
            apps[idx].name = newName.trim();
            saveCustomApps(apps);
            renderCustomApps();
          }
          contextMenu.style.display = "none";
        });

      // Change thumbnail functionality
      document
        .getElementById("change-thumbnail")
        .addEventListener("click", function () {
          if (currentAppIndex === -1) return;
          // Find by persistent id
          const order = getAppOrder();
          const id = order.filter(id => id.startsWith('custom-app-'))[currentAppIndex];
          const apps = loadCustomApps();
          const idx = apps.findIndex(app => app.id === id);
          if (idx === -1) return;
          const currentApp = apps[idx];
          const newIcon = prompt("Enter new icon URL:", currentApp.icon);
          if (newIcon && newIcon.trim() !== "") {
            apps[idx].icon = newIcon.trim();
            saveCustomApps(apps);
            renderCustomApps();
          }
          contextMenu.style.display = "none";
        });

      // Delete functionality
      document
        .getElementById("delete-app")
        .addEventListener("click", function () {
          if (currentAppIndex === -1) return;
          if (confirm("Are you sure you want to delete this app?")) {
            // Find by persistent id
            let order = getAppOrder();
            const id = order.filter(id => id.startsWith('custom-app-'))[currentAppIndex];
            let apps = loadCustomApps();
            const idx = apps.findIndex(app => app.id === id);
            if (idx === -1) return;
            apps.splice(idx, 1);
            saveCustomApps(apps);
            // Remove from order
            order = order.filter(oid => oid !== id);
            saveAppOrder(order);
            renderCustomApps();
          }
          contextMenu.style.display = "none";
        });
    </script>
    <!-- Motto area -->
    <div
      id="motto-container"
      style="
        position: fixed;
        bottom: 45px;
        left: 0;
        right: 0;
        text-align: center;
        color: #666;
        font-size: 0.95em;
        padding: 5px 10px;
        background: rgba(255, 255, 255, 0.7);
        z-index: 1999;
        border-radius: 12px;
        max-width: 800px;
        margin: 0 auto;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        user-select: none;
      "
    >
      Loading...
    </div>
    <div
      style="
        position: fixed;
        bottom: 10px;
        left: 20px;
        color: #888;
        font-size: 0.95em;
        z-index: 2000;
      "
    >
      <a
        href="https://github.com/404-Page-Found/New-Tab"
        target="_blank"
        style="color: #888; text-decoration: none"
        >New-Tab GitHub Repository</a
      >
    </div>
    <div
      style="
        position: fixed;
        bottom: 10px;
        right: 20px;
        color: #888;
        font-size: 0.95em;
        z-index: 2000;
        user-select: none;
        pointer-events: none;
      "
    >
      v0.3.2
    </div>
  </body>
</html>
