<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New-Tab</title>
  <link rel="stylesheet" href="style.css" />
    <script src="motto.js"></script>
  <script src="backgrounds.js"></script>
  </head>
  <body>
    <div class="container">
      <div id="clock" class="clock">12:00</div>
      <div id="date" class="date">Monday, June 20</div>
      <div class="search-bar">
        <select class="search-engine"></select>
        <input type="text" placeholder="Search or enter website" />
      </div>

  <div class="app-grid" id="app-grid">
        <a href="#" class="app-icon" id="add-app" draggable="false">
          <div class="icon">
            <img
              src="https://cdn-icons-png.flaticon.com/512/1828/1828817.png"
              alt="Add"
              style="width: 32px; height: 32px"
            />
          </div>
          <span class="app-name">Add</span>
        </a>
      </div>
    </div>

    <!-- Settings Modal -->
  <div id="settings-modal">
      <div>
  <div class="settings-body">
          <nav class="settings-menu">
            <button class="settings-menu-item selected" data-section="general">
              General
            </button>
            <button class="settings-menu-item" data-section="background">
              Background
            </button>
            <button class="settings-menu-item" data-section="apps">Apps</button>
            <button class="settings-menu-item" data-section="clock">
              Clock
            </button>
            <button class="settings-menu-item" data-section="date">Date</button>
          </nav>
          <div class="settings-content">
            <section class="settings-section" data-section="general">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  cursor: pointer;
                "
                onclick="document.getElementById('open-new-tab-setting').click(); return false;"
              >
                <input
                  type="checkbox"
                  id="open-new-tab-setting"
                  style="cursor: pointer"
                  onclick="event.stopPropagation();"
                />
                Open apps in a new tab
              </label>
            </section>
            <section class="settings-section" data-section="background" style="display: none">
              <div class="bg-thumbnails" id="bg-thumbnails"></div>
            </section>
            <section class="settings-section" data-section="apps" style="display: none">
              <label
                ><input type="radio" name="curvature" value="0" /> Square</label
              >
              <label
                ><input type="radio" name="curvature" value="20" />
                Rounded</label
              >
              <label
                ><input type="radio" name="curvature" value="50" />
                Circle</label
              >
            </section>
            <section class="settings-section" data-section="clock" style="display: none">
              <label
                >Color:<br /><input type="color" id="clock-color-picker"
              /></label>
              <label
                >Font:<br />
                <select id="clock-font-picker">
                  <option
                    value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
                  >
                    Default
                  </option>
                  <option value="'Arial', sans-serif">Arial</option>
                  <option value="'Courier New', monospace">Courier New</option>
                  <option value="'Times New Roman', serif">
                    Times New Roman
                  </option>
                  <option value="'Comic Sans MS', cursive">
                    Comic Sans MS
                  </option>
                  <option value="'Georgia', serif">Georgia</option>
                </select>
              </label>
              <label
                >Size:<br />
                <input
                  type="number"
                  id="clock-size-picker"
                  min="20"
                  max="200"
                  value="80"
                  style="width: 60px"
                />
                px
              </label>
              <button id="clock-style-reset">Reset Clock Style</button>
            </section>
            <section class="settings-section" data-section="date" style="display: none">
              <label
                >Color:<br /><input type="color" id="date-color-picker"
              /></label>
              <label
                >Font:<br />
                <select id="date-font-picker">
                  <option
                    value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
                  >
                    Default
                  </option>
                  <option value="'Arial', sans-serif">Arial</option>
                  <option value="'Courier New', monospace">Courier New</option>
                  <option value="'Times New Roman', serif">
                    Times New Roman
                  </option>
                  <option value="'Comic Sans MS', cursive">
                    Comic Sans MS
                  </option>
                  <option value="'Georgia', serif">Georgia</option>
                </select>
              </label>
              <label
                >Size:<br />
                <input
                  type="number"
                  id="date-size-picker"
                  min="10"
                  max="80"
                  value="24"
                  style="width: 60px"
                />
                px
              </label>
              <button id="date-style-reset">Reset Date Style</button>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- Add App Modal -->
  <div id="add-app-modal">
  <div>
        <h3 style="margin-bottom: 12px">Add New App</h3>
  <input id="add-app-url" type="text" placeholder="Enter website URL" />
  <div id="default-apps-list"></div>
        <div class="add-app-actions">
          <button id="add-app-cancel">Cancel</button>
          <button id="add-app-confirm">Add</button>
        </div>
      </div>
    </div>


    <script>
      // --- Drag and Drop for App Grid ---
      // Helper functions
      const getDraggableAppIcons = () => Array.from(document.querySelectorAll('.app-grid .app-icon')).filter(icon => icon.id !== 'add-app');
      const getAppOrder = () => JSON.parse(localStorage.getItem('appOrder') || 'null');
      const saveAppOrder = order => localStorage.setItem('appOrder', JSON.stringify(order));
      const getAllAppData = () => {
        const defaultApps = [
          { id: 'feedback-app', name: 'Feedback', url: 'https://github.com/404-Page-Found/New-Tab/issues/new', icon: 'https://cdn-icons-png.flaticon.com/512/545/545705.png', className: 'default-app' },
          { id: 'settings-app', name: 'Settings', url: '#', icon: 'https://cdn-icons-png.flaticon.com/512/3524/3524636.png', className: 'default-app' },
        ];
        const customApps = loadCustomApps().map(app => ({ ...app, className: 'custom-app' }));
        return [...defaultApps, ...customApps];
      };
      function renderAllApps() {
        const appGrid = document.getElementById('app-grid');
        const addApp = document.getElementById('add-app');
        // Remove all except Add
        Array.from(appGrid.children).forEach(child => { if (child.id !== 'add-app') appGrid.removeChild(child); });
        let order = getAppOrder();
        const allApps = getAllAppData();
        if (!order || order.length !== allApps.length) {
          order = allApps.map(app => app.id);
          saveAppOrder(order);
        }
        const appMap = Object.fromEntries(allApps.map(app => [app.id, app]));
        order.forEach(appId => {
          const app = appMap[appId];
          if (!app) return;
          const a = document.createElement('a');
          a.href = app.url;
          a.className = 'app-icon ' + app.className;
          a.id = app.id;
          a.draggable = true;
          if (app.className === 'custom-app') {
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
          }
          a.innerHTML = `<div class="icon"><img src="${app.icon}" alt="${app.name}" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/globe.svg';"></div><span class="app-name">${app.name}</span>`;
          appGrid.insertBefore(a, addApp);
        });
      }
      // Drag and drop logic
      let dragSrcId = null;
      function handleDragEvent(e) {
        const type = e.type;
        if (type === 'dragstart') {
          dragSrcId = this.id;
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        } else if (type === 'dragend') {
          this.classList.remove('dragging');
        } else if (type === 'dragover') {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          this.classList.add('drag-over');
        } else if (type === 'dragleave') {
          this.classList.remove('drag-over');
        } else if (type === 'drop') {
          e.stopPropagation();
          this.classList.remove('drag-over');
          if (dragSrcId === this.id) return;
          let order = getAppOrder();
          const fromIdx = order.indexOf(dragSrcId);
          const toIdx = order.indexOf(this.id);
          if (fromIdx === -1 || toIdx === -1) return;
          const oldOrder = order.slice();
          order.splice(toIdx, 0, order.splice(fromIdx, 1)[0]);
          saveAppOrder(order);
          renderAllApps();
          attachDnDEvents();
          if (JSON.stringify(order) !== JSON.stringify(oldOrder)) {
            setTimeout(() => location.reload(), 300);
          }
        }
      }
      function attachDnDEvents() {
        getDraggableAppIcons().forEach(icon => {
          ['dragstart','dragend','dragover','dragleave','drop'].forEach(evt => icon.addEventListener(evt, handleDragEvent));
        });
      }
      renderAllApps();
      attachDnDEvents();
      // Re-render and re-attach events after custom app changes
      renderCustomApps = function() {
        const allApps = getAllAppData();
        let order = getAppOrder();
        if (!order || order.length !== allApps.length) {
          order = allApps.map(app => app.id);
          saveAppOrder(order);
        }
        renderAllApps();
        attachDnDEvents();
      };
      function updateTime() {
        const now = new Date();
        const timeElement = document.getElementById("clock");
        const dateElement = document.getElementById("date");

        // Update time
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        timeElement.textContent = `${hours}:${minutes}`;

        // Update date
        const options = { weekday: "long", month: "long", day: "numeric" };
        dateElement.textContent = now.toLocaleDateString("en-US", options);
      }

      // Update time immediately and then every minute
      updateTime();
      setInterval(updateTime, 60000);

      // Search Engine Configuration
      const searchEngines = {
        bing: { name: "Bing", url: "https://www.bing.com/search?q=" },
        duckduckgo: { name: "DuckDuckGo", url: "https://duckduckgo.com/?q=" },
        google: { name: "Google", url: "https://www.google.com/search?q=" },
      };

      // Load saved search engine
      function getSavedEngine() {
        return localStorage.getItem("defaultEngine") || "google";
      }

      // Save search engine
      function saveEngine(engine) {
        localStorage.setItem("defaultEngine", engine);
      }

      // Initialize search engine dropdown
      function initSearchEngine() {
        const select = document.querySelector(".search-engine");
        const savedEngine = getSavedEngine();
        select.innerHTML = Object.keys(searchEngines).map(key => `<option value="${key}">${searchEngines[key].name}</option>`).join("");
        select.value = savedEngine;
        select.addEventListener("change", e => saveEngine(e.target.value));
      }

  // Modify search event listener
      document.querySelector(".search-bar input").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          const query = this.value.trim();
          if (!query) return;
          const selectedEngine = searchEngines[getSavedEngine()];
          if (query.includes(".")) {
            window.location.href = query.startsWith("http") ? query : `https://${query}`;
          } else {
            window.location.href = `${selectedEngine.url}${encodeURIComponent(query)}`;
          }
        }
      });

      // Initialize on page load
      initSearchEngine();

      // Settings modal logic
      const settingsApp = document.getElementById("settings-app");
      const settingsModal = document.getElementById("settings-modal");
  // ...existing code...
      const openNewTabSetting = document.getElementById("open-new-tab-setting");
      const appLinks = document.querySelectorAll(".app-grid .app-icon");

      // Load setting from localStorage
      function loadOpenNewTabSetting() {
        return localStorage.getItem("openAppsInNewTab") !== "false";
      }
      function applyOpenNewTabSetting() {
        const openInNewTab = loadOpenNewTabSetting();
        appLinks.forEach((link) => {
          if (link.id === "settings-app") return;
          if (openInNewTab) {
            link.setAttribute("target", "_blank");
            link.setAttribute("rel", "noopener noreferrer");
          } else {
            link.removeAttribute("target");
            link.removeAttribute("rel");
          }
        });
        openNewTabSetting.checked = openInNewTab;
      }
      openNewTabSetting.addEventListener("change", function () {
        localStorage.setItem("openAppsInNewTab", this.checked);
        applyOpenNewTabSetting();
      });
      settingsApp.addEventListener("click", function (e) {
        e.preventDefault();
        settingsModal.style.display = "flex";
      });
      // Close modal on outside click
      settingsModal.addEventListener("click", function (e) {
        if (e.target === settingsModal) settingsModal.style.display = "none";
      });

      // Add App logic
      const addAppBtn = document.getElementById("add-app");
      const addAppModal = document.getElementById("add-app-modal");
      const addAppUrlInput = document.getElementById("add-app-url");
      const addAppCancel = document.getElementById("add-app-cancel");
      const addAppConfirm = document.getElementById("add-app-confirm");
      const appGrid = document.querySelector(".app-grid");

      function getFavicon(url) {
        try {
          const u = new URL(url.startsWith("http") ? url : "https://" + url);
          return u.origin + "/favicon.ico";
        } catch {
          return "";
        }
      }

      function loadCustomApps() {
        return JSON.parse(localStorage.getItem("customApps") || "[]");
      }
      function saveCustomApps(apps) {
        localStorage.setItem("customApps", JSON.stringify(apps));
      }


      addAppBtn.addEventListener("click", function (e) {
        e.preventDefault();
        addAppModal.style.display = "flex";
        addAppUrlInput.value = "";
        addAppUrlInput.focus();
      });
      addAppCancel.addEventListener("click", function () {
        addAppModal.style.display = "none";
      });
      addAppModal.addEventListener("click", function (e) {
        if (e.target === addAppModal) addAppModal.style.display = "none";
      });
      addAppConfirm.addEventListener("click", function () {
        const url = addAppUrlInput.value.trim();
        if (!url) return;
        let name = url.replace(/^https?:\/\//, "").split("/")[0];
        const icon = getFavicon(url);
        const apps = loadCustomApps();
        // Assign a persistent unique id
        const id = 'custom-app-' + Date.now() + '-' + Math.floor(Math.random()*100000);
        apps.push({
          id,
          url: url.startsWith("http") ? url : "https://" + url,
          name,
          icon,
        });
        saveCustomApps(apps);
        // Update appOrder to include new app
        let order = getAppOrder() || [];
        order.push(id);
        saveAppOrder(order);
        renderCustomApps();
        addAppModal.style.display = "none";
      });

      // Curvature logic (radio buttons)
      const curvatureRadios = document.querySelectorAll(
        'input[name="curvature"]'
      );
      function loadCurvature() {
        return localStorage.getItem("appsButtonCurvature") || "20";
      }
      function applyCurvature() {
        const radius = loadCurvature();
        // Set CSS variable for icon border-radius
        document.documentElement.style.setProperty('--icon-radius', radius + 'px');
        for (let i = 0; i < curvatureRadios.length; i++) {
          curvatureRadios[i].checked = curvatureRadios[i].value === radius;
        }
      }
      curvatureRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
          if (this.checked) {
            localStorage.setItem("appsButtonCurvature", this.value);
            applyCurvature();
          }
        });
      });

      // Background selection logic
  // Thumbnails are generated by backgrounds.js; ensure initialization
  if (window._initBackgrounds) window._initBackgrounds();
  const bgThumbnails = document.getElementById('bg-thumbnails');
      function loadBg() {
        return localStorage.getItem("homepageBg") || "default";
      }
      function applyBg() {
        const bg = loadBg();
        document.body.setAttribute("data-bg", bg);
        const thumbs = document.querySelectorAll('.bg-thumb');
        for (let i = 0; i < thumbs.length; i++) {
          thumbs[i].classList.toggle('selected', thumbs[i].getAttribute('data-bg') === bg);
        }
        if (bg !== 'default') {
          const imgUrl = (window._findBackgroundUrlById && window._findBackgroundUrlById(bg)) || '';
          if (imgUrl) document.body.style.background = `url('${imgUrl}') center center/cover no-repeat fixed`;
          else document.body.style.background = '';
        } else {
          document.body.style.background = '';
        }
      }

      // Delegate click events for dynamically-created thumbnails
      document.addEventListener('click', function (e) {
        const t = e.target.closest && e.target.closest('.bg-thumb');
        if (t && t.getAttribute('data-bg')) {
          localStorage.setItem('homepageBg', t.getAttribute('data-bg'));
          applyBg();
        }
      });

      // Clock style settings logic
      const clock = document.getElementById("clock");
      const clockColorPicker = document.getElementById("clock-color-picker");
      const clockFontPicker = document.getElementById("clock-font-picker");
      const clockSizePicker = document.getElementById("clock-size-picker");
      const clockStyleReset = document.getElementById("clock-style-reset");
      // Date style settings logic
      const date = document.getElementById("date");
      const dateColorPicker = document.getElementById("date-color-picker");
      const dateFontPicker = document.getElementById("date-font-picker");
      const dateSizePicker = document.getElementById("date-size-picker");
      const dateStyleReset = document.getElementById("date-style-reset");

      function loadClockStyle() {
        return {
          color: localStorage.getItem("clockColor") || "#ffffff",
          font:
            localStorage.getItem("clockFont") ||
            "'Times New Roman', serif",
          size: localStorage.getItem("clockSize") || "80",
        };
      }
      function applyClockStyle() {
        const style = loadClockStyle();
        clock.style.color = style.color;
        clock.style.fontFamily = style.font;
        clock.style.fontSize = style.size + "px";
        if (clockColorPicker.value !== style.color) clockColorPicker.value = style.color;
        if (clockFontPicker.value !== style.font) clockFontPicker.value = style.font;
        if (clockSizePicker.value !== style.size) clockSizePicker.value = style.size;
      }
      clockColorPicker.addEventListener("input", function () {
        localStorage.setItem("clockColor", this.value);
        applyClockStyle();
      });
      clockFontPicker.addEventListener("change", function () {
        localStorage.setItem("clockFont", this.value);
        applyClockStyle();
      });
      clockSizePicker.addEventListener("input", function () {
        let val = this.value;
        if (val < 20) val = 20;
        if (val > 200) val = 200;
        localStorage.setItem("clockSize", val);
        applyClockStyle();
      });
      clockStyleReset.addEventListener("click", function () {
        localStorage.removeItem("clockColor");
        localStorage.removeItem("clockFont");
        localStorage.removeItem("clockSize");
        applyClockStyle();
      });
      // Date style logic
      function loadDateStyle() {
        return {
          color: localStorage.getItem("dateColor") || "#ffffff",
          font:
            localStorage.getItem("dateFont") ||
            "'Times New Roman', serif",
          size: localStorage.getItem("dateSize") || "24",
        };
      }
      function applyDateStyle() {
        const style = loadDateStyle();
        date.style.color = style.color;
        date.style.fontFamily = style.font;
        date.style.fontSize = style.size + "px";
        if (dateColorPicker.value !== style.color) dateColorPicker.value = style.color;
        if (dateFontPicker.value !== style.font) dateFontPicker.value = style.font;
        if (dateSizePicker.value !== style.size) dateSizePicker.value = style.size;
      }
      dateColorPicker.addEventListener("input", function () {
        localStorage.setItem("dateColor", this.value);
        applyDateStyle();
      });
      dateFontPicker.addEventListener("change", function () {
        localStorage.setItem("dateFont", this.value);
        applyDateStyle();
      });
      dateSizePicker.addEventListener("input", function () {
        let val = this.value;
        if (val < 10) val = 10;
        if (val > 80) val = 80;
        localStorage.setItem("dateSize", val);
        applyDateStyle();
      });
      dateStyleReset.addEventListener("click", function () {
        localStorage.removeItem("dateColor");
        localStorage.removeItem("dateFont");
        localStorage.removeItem("dateSize");
        applyDateStyle();
      });
  // Initial setup
  applyOpenNewTabSetting();
  applyCurvature();
  applyBg();
  applyClockStyle();
  applyDateStyle();

      // Settings menu logic (optimized, single event listener)
      const settingsMenuItems = document.querySelectorAll(".settings-menu-item");
      const settingsSections = document.querySelectorAll(".settings-section");
      settingsMenuItems.forEach((item) => {
        item.addEventListener("click", function () {
          const section = this.getAttribute("data-section");
          settingsMenuItems.forEach((i) => i.classList.remove("selected"));
          this.classList.add("selected");
          settingsSections.forEach((s) => {
            s.style.display =
              s.getAttribute("data-section") === section ? "block" : "none";
          });
        });
      });

      // --- Add App Modal: Default Apps List ---
      // Re-attach drag and drop after adding default app
      addAppBtn.addEventListener('click', function() {
        setTimeout(attachDnDEvents, 100);
      });
      const defaultApps = [
        {
          name: "Google",
          url: "https://www.google.com",
          icon: "https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png",
        },
        {
          name: "YouTube",
          url: "https://www.youtube.com",
          icon: "https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg",
        },
        {
          name: "GitHub",
          url: "https://www.github.com",
          icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
        },
        {
          name: "Gmail",
          url: "https://www.gmail.com",
          icon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico",
        },
        {
          name: "Twitter",
          url: "https://www.twitter.com",
          icon: "https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/x.svg",
        },
        {
          name: "Facebook",
          url: "https://www.facebook.com",
          icon: "https://facebook.com/favicon.ico",
        },
        {
          name: "Feedback",
          url: "https://github.com/404-Page-Found/New-Tab/issues/new",
          icon: "https://cdn-icons-png.flaticon.com/512/545/545705.png",
        },
      ];
      const defaultAppsList = document.getElementById("default-apps-list");
      function renderDefaultAppsList() {
        defaultAppsList.innerHTML = "";
        // Cache app names for existence check
        const existingNames = new Set(Array.from(document.querySelectorAll(".app-icon .app-name")).map(e => e.textContent));
        for (let i = 0; i < defaultApps.length; i++) {
          const app = defaultApps[i];
          const btn = document.createElement("button");
          btn.style.display = "inline-flex";
          btn.style.alignItems = "center";
          btn.style.gap = "8px";
          btn.style.margin = "2px 4px 2px 0";
          btn.style.padding = "6px 12px";
          btn.style.border = "1px solid #ddd";
          btn.style.borderRadius = "8px";
          btn.style.background = "#f5f7fa";
          btn.style.cursor = "pointer";
          btn.innerHTML = `${
            app.icon
              ? `<img src="${app.icon}" alt="${app.name}" style="width:20px;height:20px;object-fit:contain;background:#f5f7fa;display:block;">`
              : `<span style='display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:6px;background:#fff;font-size:16px;font-weight:bold;'>T</span>`
          } <span>${app.name}</span>`;
          btn.addEventListener("click", function () {
            if (existingNames.has(app.name)) return;
            const apps = loadCustomApps();
            const id = 'custom-app-' + Date.now() + '-' + Math.floor(Math.random()*100000);
            apps.push({ id, url: app.url, name: app.name, icon: app.icon });
            saveCustomApps(apps);
            let order = getAppOrder() || [];
            order.push(id);
            saveAppOrder(order);
            renderCustomApps();
            addAppModal.style.display = "none";
          });
          defaultAppsList.appendChild(btn);
        }
      }


      // Prevent default behavior only when the app icon is not clicked
      document.addEventListener("contextmenu", function (e) {
        if (!e.target.closest(".app-icon.custom-app, .app-icon.default-app")) e.preventDefault();
      });
      // Display a motto that stays the same for each day
      function displayDailyMotto() {
        try {
          const now = new Date();
          // Use year, month, and day to get a unique number for the day
          const daySeed = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate();
          // Deterministically pick a motto for the day
          const index = daySeed % motto.length;
          const mottoContainer = document.getElementById("motto-container");
          if (mottoContainer) {
            mottoContainer.textContent = motto[index];
            // Add fade-in effect
            mottoContainer.style.opacity = "0";
            setTimeout(() => {
              mottoContainer.style.transition = "opacity 0.5s";
              mottoContainer.style.opacity = "1";
            }, 50);
          }
        } catch (e) {
          console.error("Error displaying motto:", e);
        }
      }

      // Set the motto after the page has finished loading
      document.addEventListener("DOMContentLoaded", displayDailyMotto);
      // Create context menu element
      const contextMenu = document.createElement("div");
      contextMenu.id = "app-context-menu";
      contextMenu.style.cssText = `
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        z-index: 3000;
        min-width: 160px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 14px;
        color: #333;
      `;

      // Menu items
      const renameItem = document.createElement("div");
      renameItem.id = "rename-app";
      renameItem.textContent = "Rename";
      renameItem.style.cssText =
        "padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;";

      const changeThumbnailItem = document.createElement("div");
      changeThumbnailItem.id = "change-thumbnail";
      changeThumbnailItem.textContent = "Change Thumbnail";
      changeThumbnailItem.style.cssText =
        "padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;";

      const deleteItem = document.createElement("div");
      deleteItem.id = "delete-app";
      deleteItem.textContent = "Delete";
      deleteItem.style.cssText =
        "padding: 8px 12px; cursor: pointer; color: #f44336; transition: background 0.2s;";

      // Add hover effects
      [renameItem, changeThumbnailItem, deleteItem].forEach((item) => {
        item.addEventListener(
          "mouseenter",
          () => (item.style.background = "#f5f7fa")
        );
        item.addEventListener(
          "mouseleave",
          () => (item.style.background = "white")
        );
      });

      contextMenu.appendChild(renameItem);
      contextMenu.appendChild(changeThumbnailItem);
      contextMenu.appendChild(deleteItem);
      document.body.appendChild(contextMenu);

      // Track which app is being interacted with
      let currentAppIndex = -1;

      // Add right-click event listener to custom apps
      document.addEventListener("contextmenu", function (e) {
        const appIcon = e.target.closest(".app-icon.custom-app");
        if (appIcon) {
          e.preventDefault();

          // Find the index of this app
          const appGrid = document.querySelector(".app-grid");
          const apps = Array.from(
            appGrid.querySelectorAll(".app-icon.custom-app")
          );
          currentAppIndex = apps.indexOf(appIcon);

          // Position and show context menu
          // Adjust position if near screen edge
          let left = e.pageX;
          let top = e.pageY;

          if (left + 160 > window.innerWidth) {
            left = window.innerWidth - 160 - 10;
          }

          if (top + 100 > window.innerHeight) {
            top = window.innerHeight - 100 - 10;
          }

          contextMenu.style.left = left + "px";
          contextMenu.style.top = top + "px";
          contextMenu.style.display = "block";
        }
      });

      // Hide context menu when clicking elsewhere
      document.addEventListener("click", function (e) {
        if (!contextMenu.contains(e.target) && e.button !== 2) {
          contextMenu.style.display = "none";
        }
      });

      // Rename functionality
      document
        .getElementById("rename-app")
        .addEventListener("click", function () {
          if (currentAppIndex === -1) return;
          // Find by persistent id
          const order = getAppOrder();
          const id = order.filter(id => id.startsWith('custom-app-'))[currentAppIndex];
          const apps = loadCustomApps();
          const idx = apps.findIndex(app => app.id === id);
          if (idx === -1) return;
          const currentApp = apps[idx];
          const newName = prompt("Enter new name:", currentApp.name);
          if (newName && newName.trim() !== "") {
            apps[idx].name = newName.trim();
            saveCustomApps(apps);
            renderCustomApps();
            location.reload();
          }
          contextMenu.style.display = "none";
        });

      // Change thumbnail functionality
      document
        .getElementById("change-thumbnail")
        .addEventListener("click", function () {
          if (currentAppIndex === -1) return;
          // Find by persistent id
          const order = getAppOrder();
          const id = order.filter(id => id.startsWith('custom-app-'))[currentAppIndex];
          const apps = loadCustomApps();
          const idx = apps.findIndex(app => app.id === id);
          if (idx === -1) return;
          const currentApp = apps[idx];
          const newIcon = prompt("Enter new icon URL:", currentApp.icon);
          if (newIcon && newIcon.trim() !== "") {
            apps[idx].icon = newIcon.trim();
            saveCustomApps(apps);
            renderCustomApps();
            location.reload();
          }
          contextMenu.style.display = "none";
        });

      // Delete functionality
      document
        .getElementById("delete-app")
        .addEventListener("click", function () {
          if (currentAppIndex === -1) return;
          if (confirm("Are you sure you want to delete this app?")) {
            // Find by persistent id
            let order = getAppOrder();
            const id = order.filter(id => id.startsWith('custom-app-'))[currentAppIndex];
            let apps = loadCustomApps();
            const idx = apps.findIndex(app => app.id === id);
            if (idx === -1) return;
            apps.splice(idx, 1);
            saveCustomApps(apps);
            // Remove from order
            order = order.filter(oid => oid !== id);
            saveAppOrder(order);
            renderCustomApps();
            location.reload();
          }
          contextMenu.style.display = "none";
        });
    </script>
    <!-- Motto area -->
  <div id="motto-container">
      Loading...
    </div>
  <div class="footer-left">
  <a href="https://github.com/404-Page-Found/New-Tab" target="_blank" class="footer-link">New-Tab GitHub Repository</a>
    </div>
  <div class="footer-right">
      v0.3.4
    </div>
  </body>
</html>
